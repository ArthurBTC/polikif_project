{% extends 'gdpcore/base.html' %}

{% block content %}



<!-- Pas de cache, jointjs plante avec du cache -->	
<meta http-equiv='cache-control' content='no-cache'>
<meta http-equiv='expires' content='0'>
<meta http-equiv='pragma' content='no-cache'>

<!-- ^((?!cast_sender).)*$ -->


<div id = "actionGraph" class="btn-group" role="group">
	<button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenuGraph" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
		<span class="glyphicon glyphicon-th" aria-hidden="true"></span> Graphique
		<span class="caret"></span>
	</button>

	<ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
		<li><a data-toggle="modal" data-target="#modalSave">Sauvegarder le graphique</a></li>
		<li><a>Partager le graphique</a></li>
		<li><a>Ouvrir un nouveau graphique</a></li>
		<li role="separator" class="divider"></li>
		<li><a data-toggle="modal" data-target="#modalExistingprop">Ajouter une proposition existante</a></li>
		<li><a data-toggle="modal" data-target="#modalNewprop">Créer une nouvelle proposition</a></li>
		<li><a data-toggle="modal" data-target="#modalSyllogism">Créer un Syllogisme</a></li>

	</ul>
</div>

<!-- Action sur proposition -->
<div id = "actionProp" class="btn-group" role="group">
	<button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenuProp" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
		<span class="glyphicon glyphicon-align-center" aria-hidden="true"></span> Proposition
		<span class="caret"></span>
	</button>
	<ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
		<li><a data-toggle="modal" data-target="#modalAnswer">Répondre à la proposition</a></li>
		<li><a data-toggle="modal" data-target="#modalConnect">Connecter à une proposition existante</a></li>
		<li role="separator" class="divider"></li>
		<li><a data-toggle="modal" data-target="#modalForum">Ouvrir le forum</a></li>
		<li><a data-toggle="modal" data-target="#modalSummary">Voir le résumé</a></li>
		<li role="separator" class="divider"></li>
		<li><a data-toggle="modal" data-target="#modalEdit">Modifier la proposition</a></li>
		<li role="separator" class="divider"></li>
		<li><a id ='remove_prop'>Masquer la proposition</a></li>
	</ul>
</div>


<button id = "adminBut" type="button" class="btn btn-default" aria-label="Left Align">
	<span class="glyphicon glyphicon-align-center" aria-hidden="true"></span> Admin
</button>


<!-- Action link -->
<div id = "actionLink" class="btn-group" role="group">		
	<button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
		<span class="glyphicon glyphicon-resize-horizontal" aria-hidden="true"></span> Lien
		<span class="caret"></span>
	</button>		
	<ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
		<li><a data-toggle="modal" data-target="#modalLinkAttack">Critiquer le lien</a></li>
		<li><a data-toggle="modal" data-target="#modalLinkRemove">Supprimer le lien</a></li>
	</ul>		
</div>

<button id = "quickSave" type="button" class="btn btn-default" aria-label="Left Align">
	<span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Sauvegarde
</button>
<div id="savedMessage">Sauvegarde effectuée</div>

<div id="ytplayer"></div>

<div class ="row">
	<div class="col-md-4">
	
		<div id="chat">
			<div id="commentsGraph">
			{% for comment in comments_graph %}			
				<div>{{comment.creation_date|timesince}} - {{comment.author.username}} : {{comment.text}}</div>
			{% endfor %}
			</div>
			
			<div class="form-group">
				<input type="text" class="form-control" id="commentGraphInput" name="commentGraphInput" placeholder="Répondre...">
			</div>	
			<button id ="commentGraphSubmit" class="btn btn-primary">Répondre</button>					
		</div>

		<div id="envir_info_container">
			<div id = "cons_display"></div>							
		</div>		

	</div>
	<div class="col-md-8">	

<!-- Paper, liens, actions... -->		
		<div id="myholder"></div>			
	</div>

</div>

<!-- Modaux -->		
	<!-- Réponse Proposition+Lien -->	
	<div class="modal fade" id="modalAnswer" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="modalAnswerLabel">Ajouter une proposition</h4>
		  </div>
		  
		  <div class="modal-body">	


			  <ul class="nav nav-tabs" role="tablist">
				<li role="presentation" class="active"><a href="#classic" aria-controls="classic" role="tab" data-toggle="tab">Diagnostic</a></li>
				<li role="presentation"><a href="#yt" aria-controls="yt" role="tab" data-toggle="tab">Youtube</a></li>
			  </ul>

				<div class="tab-content" id ="myTabs" >
					<div role="tabpanel" class="tab-pane active" id="classic">	
		  
						<!-- Proposition initiale-->
						<div id="ini_prop_answer"></div>									
						<!-- Choix connecteur-->			
						{% for link_type in link_types %}			
							<div class="radio newprop">
							  <label>
								<input type="radio" name="optionsRadios" id="optionsRadios{{link_type.id}}" value="{{link_type.id}}" checked>
								{{link_type.text}}
							  </label>
							</div>							
						{% endfor %}			
							
						<!-- Proposition entrée-->
						 <div class="form-group">
							<input type="text" class="form-control newprop" id="newprop" name="newprop" placeholder="Entrez votre nouvelle proposition...">
						  </div>
								 
						<!-- Logique générée-->			
						<div class="alert alert-info" role="alert" id="answerLogic"></div>
						
						<!-- Checkbox logique-->
						  <div class="checkbox">
							<label>
							  <input type="checkbox">Je confirme la logique
							</label>
						  </div>		  
						  
						<!-- Recherche propositions similaires-->
						  <button type="button" class="btn btn-info" id="recherche_but">Rechercher propositions similaires</button> 
						  
						  <div id = 'existingPropsAnswer_modalAnswer'></div>
						  
						  <div class="checkbox">
							<label>
							  <input type="checkbox"> Je n'ai trouvé aucune proposition similaire
							</label>
						  </div>	
						 <button id ="submit_answer" class="btn btn-primary">Ajouter proposition</button>
					</div>
					
					<div role="tabpanel" class="tab-pane active" id="yt">	
					
						<div class="form-group">
							<label for="answer_youtubetitle">Titre</label>
							<input type="text" class="form-control" id="answer_youtubeTitle" name='answer_youtubetitle' placeholder="Entrez le titre">
						</div>				

						<div class="form-group">
							<label for="answer_youtubeid">Id youtube (Exemple : F9NPnKZkF-Y)</label>
							<input type="text" class="form-control" id="answer_youtubeId" name='answer_youtubeid' placeholder="Exemple : F9NPnKZkF-Y">
						</div>

						<div class="form-group">
							<label for="answer_youtubeBegin">Debut (en seconde)</label>
							<input type="number" class="form-control" id="answer_youtubeBegin" name='answer_youtubeid' placeholder="0">
						</div>

						<div class="form-group">
							<label for="answer_youtubeEnd">Fin (en seconde)</label>
							<input type="number" class="form-control" id="answer_youtubeEnd" name='answer_youtubeid' placeholder="1000">
						</div>
						
						<div id='answer_playerPrev'></div>
					
						<button id = "answer_youtubePreview" class="btn btn-default">Visualiser extrait</button>
						<button id = "answer_youtubeSubmit" class="btn btn-default">Créer extrait</button>															
					
					</div>
					
				</div>
				
				
				
			</div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
			
			
		  </div>
		
		</div>
	  </div>
	</div>		

	<!-- Connect -->
	<div class="modal fade" id="modalConnect" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="modalConnectLabel">Connecter à une proposition</h4>
		  </div>
		  
		  <div class="modal-body">
			
			<!-- Proposition initiale-->
			<div id="ini_prop_connect"></div>
				
			{% for link_type in link_types %}
			
				<div class="radio newprop">
				  <label>
					<input type="radio" name="connectOptions" id="connectOption{{link_type.id}}" value="{{link_type.id}}" checked>
					{{link_type.text}}
				  </label>
				</div>				
			
			{% endfor %}
		  	
				<!-- Choix de prop-->
				 <div class="form-group newprop">	 
					 <select id = 'listprops' class="form-control">
					</select>			 
				  </div>			  
				  		 
				<!-- Logique générée-->			
				<div class="alert alert-info" role="alert" id="connectLogic"></div>
				
				<!-- Checkbox logique-->
				  <div class="checkbox">
					<label>
					  <input type="checkbox">Je confirme la logique
					</label>
				  </div>		  
		  </div>		
		  
		  <div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
				<button id ="submit_connect" class="btn btn-primary">Connecter les propositions</button>
		  </div>
		  
		</div>
	  </div>
	</div>		
	
	<!-- Save Graph -->	
	<div class="modal fade" id="modalSave" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="modalSaveLabel">Sauvegarder</h4>
		  </div>
		  <div class="modal-body">
			<input id="graph_title" value="{{graph.title}}"></input>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			<button type="button" class="btn btn-primary" id="save_graph">Save changes</button>
		  </div>
		</div>
	  </div>
	</div>		

	<!-- Forum -->
	<div class="modal fade" id="modalForum" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="modalForumLabel"></h4>
		  </div>
		  <div class="modal-body">
			
				<ul id = "modalForumContent">
				{% for comment in comments %}
				<li>{{comment.creation_date|date:'Y-m-d H:i'}} {{comment.autor.username}} {{comment.text}}</li>
				{% endfor %}
				</ul>	
				  
			<form method="post" action="/gdpcore/text_request/{{id_prop}}">
			{% csrf_token %}
			
			  <div class="form-group">
				<label for="exampleInputEmail1">Répondre</label>
				<input type="text" class="form-control" id="comment_text" name='reponse' placeholder="Entrez votre réponse...">
			  </div>
			</form>
			
			  <button id = "comment_submit" class="btn btn-default">Submit</button>		
			
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		  </div>
		</div>
	  </div>
	</div>		
	
	<!-- Edition -->
	<div class="modal fade" id="modalEdit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="modalEditLabel">Modifier proposition</h4>
		  </div>
		  <div class="modal-body">
					  
			<form method="post" action="/gdpcore/edit_proposition/{{id_prop}}">
			{% csrf_token %}
			
			  <div class="form-group">
				<label for="exampleInputEmail1">Nouvel intitulé</label>
				<input type="text" class="form-control" id="edit_prop" name='edit' placeholder="{{main_prop.text}}">
			  </div>
			</form>
			  <div id = "edit_recherche_but" class="btn btn-default">Recherche proposition similaire</div>

			  <button id = "submit_edition" class="btn btn-default">Modifier ma proposition</button>
			
				
			
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		  </div>
		</div>
	  </div>
	</div>

	<!-- Nouvelle proposition -->
	<div class="modal fade" id="modalNewprop" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="modalNewpropLabel">Nouvelle proposition</h4>
		  </div>
		  <div class="modal-body">
					  
			
			
			  <ul class="nav nav-tabs" role="tablist">
				<li role="presentation" class="active"><a href="#diag" aria-controls="diag" role="tab" data-toggle="tab">Diagnostic</a></li>
				<li role="presentation"><a href="#youtube" aria-controls="youtube" role="tab" data-toggle="tab">Youtube</a></li>
			  </ul>
			
			
			<div class="tab-content">
				<div role="tabpanel" class="tab-pane active" id="diag">			
					<div class="form-group">
						<label for="propnew">Nouvel intitulé</label>
						<input type="text" class="form-control" id="propnew" name='propnew' placeholder="">
					</div>
					<div id = "newprop_recherche_but" class="btn btn-default">Recherche proposition similaire</div>
					<button id = "submit_newprop" class="btn btn-default">Ajouter ma proposition</button>
					
				</div>
				
				<div role="tabpanel" class="tab-pane" id="youtube">
					<div class="form-group">
						<label for="youtubetitle">Titre</label>
						<input type="text" class="form-control" id="youtubeTitle" name='youtubetitle' placeholder="Entrez le titre">
					</div>				

					<div class="form-group">
						<label for="youtubeid">Id youtube (Exemple : F9NPnKZkF-Y)</label>
						<input type="text" class="form-control" id="youtubeId" name='youtubeid' placeholder="Exemple : F9NPnKZkF-Y">
					</div>

					<div class="form-group">
						<label for="youtubeBegin">Debut (en seconde)</label>
						<input type="number" class="form-control" id="youtubeBegin" name='youtubeid' placeholder="0">
					</div>

					<div class="form-group">
						<label for="youtubeEnd">Fin (en seconde)</label>
						<input type="number" class="form-control" id="youtubeEnd" name='youtubeid' placeholder="1000">
					</div>
					
					<div id='playerPrev'></div>
				
					<button id = "youtubePreview" class="btn btn-default">Visualiser extrait</button>
					<button id = "youtubeSubmit" class="btn btn-default">Créer extrait</button>
				</div>
			</div>			
			
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		  </div>
		</div>
	  </div>
	</div>
	
	<!-- Critiquer un lien -->
	<div class="modal fade" id="modalLinkAttack" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="modalLinkAttackLabel">Critiquer un lien</h4>
		  </div>
		  <div class="modal-body">
					  
				<div id = "attackLogic"></div>
					  
				<div class="form-group">
					<label for="Implication">Implication</label>
					<input type="text" class="form-control" id="linkImplication" name='implication' placeholder="Ce lien implique que...">
				</div>

				<div class="form-group">
					<label for="Implication">Concurrence</label>
					<input type="text" class="form-control" id="linkAttack" name='attack' placeholder="Mais il s'avère que...">
				</div>
				
				<button id = "submitAttack" class="btn btn-primary">Envoyer ma critique</button>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
		  </div>

		</div>
	  </div>
	</div>

	<!-- Supprimer un lien -->
	<div class="modal fade" id="modalLinkRemove" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="modalLinkRemoveLabel">Critiquer un lien</h4>
		  </div>
		  <div class="modal-body">		  
				<div id = "removeLogic"></div>
				<button id = "submitRemove" class="btn btn-primary">Supprimer le lien</button>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
		  </div>
		</div>
	  </div>
	</div>
	
	<!-- Supprimer un lien -->
	<div class="modal fade" id="modalSyllogism" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="modalSyllogismLabel">Créer un syllogisme</h4>
		  </div>
		  <div class="modal-body">		  
				<!-- Choix de prop-->
				 <div class="form-group syllogismProps">	 
					 <select id = 'majorPremise' class="form-control">
					</select>			 
				  </div>
				  
				 <div class="form-group syllogismProps">	 
					 <select id = 'minorPremise' class="form-control">
					</select>			 
				  </div>				  

				 <div class="form-group syllogismProps">	 
					 <select id = 'syllogismConclusion' class="form-control">
					</select>			 
				  </div>
				  
				  <!-- Logique générée-->			
					<div class="alert alert-info" role="alert" id="syllogismLogic"></div>
				  
				 <button id ="submitSyllogism" class="btn btn-primary">Créer le syllogisme</button> 
				  
				  
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
		  </div>
		</div>
	  </div>
	</div>
	
	<!-- Voir le résumé -->
	<div class="modal fade" id="modalSummary" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="modalSummaryLabel">Créer un syllogisme</h4>
		  </div>
		  <div class="modal-body">
			<div>- Pour</div>
			<div id="summaryPour"></div>
			<div>- Contre</div>
			<div id="summaryContre"></div>
			<div>- Neutre</div>
			<div id="summaryNeutre"></div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
		  </div>
		</div>
	  </div>
	</div>
	
	<!-- Proposition existante -->
	<div class="modal fade" id="modalExistingprop" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="modalExistingpropLabel">Ajouter une proposition existante</h4>
		  </div>
		  <div class="modal-body">
		  
				<div class="form-group">
					<label for="Implication">Mots clefs</label>
					<input type="text" class="form-control" id="existingInput" name='existingInput' placeholder="Mots clefs..">
				</div>
				<button type="button" id = "existingSeek" class="btn btn-default">Chercher</button>
				
				<div id = 'existingPropsAnswer'></div>
	
				<button type="button" id = "existingSubmit" class="btn btn-default">Ajouter</button>
				
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
		  </div>
		</div>
	  </div>
	</div>
		

	
<!-- pour la recherche de propositions similaires-->
	<form id="invisible_form" action="/gdpcore/similar_propositions" method="post" target="_blank">
	{% csrf_token %}
	<input id="new_window_parameter_1" name="parameter" type="hidden" value="default">
</form>	


{% endblock %}
{% block script %}
<!-- YOUTUBE -->
<script>

  // Load the IFrame Player API code asynchronously.
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/player_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  // Replace the 'ytplayer' element with an <iframe> and
  // YouTube player after the API code downloads.
      var player;
      function onYouTubeIframeAPIReady() {
       		player = new YT.Player('ytplayer', {
			  height: '200',
			  width: '400',
			  videoId: '',
			  events: {
				'onReady': console.log('player loaded'),
				'onStateChange': ''
			  }
			});
			
			playerPrev = new YT.Player('playerPrev', {
			  height: '220',
			  width: '400',
			  videoId: '',
			  events: {
				'onReady': console.log('playerPrev loaded'),
				'onStateChange': ''
			  }
			});
			  
			answer_playerPrev = new YT.Player('answer_playerPrev', {
			  height: '220',
			  width: '400',
			  videoId: '',
			  events: {
				'onReady': console.log('answer_playerPrev loaded'),
				'onStateChange': ''
			  }			  
			});
      }
	 $("#ytplayer").hide();  
	 
</script>

<script type="text/javascript">

// INITIALISATION
$( document ).ready(function() {
  
	//Pour les tools tips
	$(function () {
	  $('[data-toggle="tooltip"]').tooltip()
	})
 	
	var colors = {'CCR':'#E71D36','D':'#2EC4B6','E':'#2EC4B6', 'I':'#2EC4B6', 'HL': '#FF9F1C'}		
	var typesData = {};

	{% for link_type in link_types %}			
		typesData['{{link_type.id}}'] = {
							'type' : '{{link_type.type|escapejs}}',
							'logic' : '{{link_type.logic|escapejs}}',
							'inverse' : '{{link_type.inverse|escapejs}}',
							'source': {
							{% if link_type.arrows > 1 %}
								fill: '{{link_type.strokeColor|escapejs}}',
								stroke: 'none',
								d: 'M 10 0 L 0 5 L 10 10 z'	
							{% endif %}
							} ,
							'target': {
							{% if link_type.arrows > 0 %}
								fill: '{{link_type.strokeColor|escapejs}}',
								stroke: 'none',
								d: 'M 10 0 L 0 5 L 10 10 z'	
							{% endif %}
							},
							'connection': {
								stroke: '{{link_type.strokeColor|escapejs}}',
								'stroke-width': {{link_type.strokeWidth}}							
							}
						} ; 		
	{% endfor %}
	
	//On va stocker tous les ronds la-dedans, pour gérer leurs positions	
	var circles = [];
	var syls = [];
	
	//Correspondances id
	propIdCorrespondance = {};
	linkIdCorrespondance = {};
	circleIdCorrespondance = {};
	authorList = {};
	authorList[{{user.id}}] = '{{user.username|escapejs}}'

	//Ini graph
    var graph = new joint.dia.Graph;
	
	//Ini paper
    var paper = new joint.dia.Paper({
        el: $('#myholder'),
        width: 66/100*$(window).width(),
        height: $(window).height(),
        model: graph,
        gridSize: 1,
		interactive: function(cellView) {
			if (cellView.model instanceof joint.dia.Link) {
				// Disable the default vertex add functionality on pointerdown.
				return { vertexAdd: false };
			}
        return true;
		}
    });
	
	//On met tout à la bonne taille
	$(function(){
		var he = $(window).height();
        var wi = $(window).width();
		$("#chat").height(60/100*he);
		$("#envir_info_container").height(40/100*he);
		paper.setDimensions(66/100*wi, 99/100*he);
		
		$(window).resize(function(){
		
			var he = $(window).height();
			var wi = $(window).width();
			$("#chat").height(60/100*he);
			$("#envir_info_container").height(40/100*he);
			paper.setDimensions(66/100*wi, 99/100*he);
		})          
	});
	
	var selectedElement = '';
	
	//Variables pour le paper
	var graphScale = 1;
	var originX = {{graph.originx}};
	var originY = {{graph.originy}};
	var sensibility = 20;	
	
	paper.setOrigin(originX, originY);

	
	//Créer une proposition
	function addProp(id_prop, text, autorname) {

		var wraptext = joint.util.breakText(text, {
			width: 145,
			height: 90,
			attrs: {		
				'text-anchor': 'middle'		
			}
		});	

		joint.shapes.basic.twoTextRect = joint.shapes.basic.Generic.extend({

			markup: '<g class="rotatable">'
						+'<g class="scalable">'
							+'<rect/>'
						+'</g>'
						+'<text class = "word1"></text>'
						+'<text class = "word2"></text>'
					+'</g>',

			defaults: joint.util.deepSupplement({

				type: 'basic.twoTextRect',
				attrs: {
					rect: { 
						fill: '#EEEEEE', 
						stroke: '', 
						'stroke-width': 1, 
						'follow-scale': true, 
						width: 150, 
						height: 80
					},

					'.word2': { 
						'font-size': 15,
						'font-weight': 'bold',
						fill: 'black', 
						'text-anchor':'end',
						transform: "translate(165,82)" 
					},
					'.word1': { 
						'ref': 'rect',
						'font-size': 15,
						'text-anchor':'middle',
						transform: "translate(95,20)" ,
						fill: 'black',
						'dy': 100		
					}
				},
				size: { width: 200, height: 100 },
				id_prop : id_prop,
				text : text
			}, joint.shapes.basic.Generic.prototype.defaults)
		});

		var el = new joint.shapes.basic.twoTextRect();
		el.attr('.word1/text', wraptext);
		el.attr('.word2/text', autorname);
		el.attr('./display', 'none');	
		graph.addCell(el);

		console.log('prop added to graph - id_prop: '+id_prop+' id: '+el.id)
		
		return(el)
	}

	//ajouter une vidéo youtube
	function addYoutube(id_prop, text, ytid, ytbeginning, ytend) {

		var wraptext = joint.util.breakText(text, {
			width: 145,
			height: 90,
			attrs: {		
				'text-anchor': 'middle'		
			}
		});
	
		joint.shapes.basic.youtubeVideo = joint.shapes.basic.Generic.extend({

			markup: '<g class="rotatable"><g class="scalable"><rect/></g><image/><text/></g>',

			defaults: joint.util.deepSupplement({

				type: 'basic.youtubeVideo',
				size: { width: 200, height: 100 },
				attrs: {
					'rect': { fill: '#EEEEEE', stroke: '', width: 200, height: 100 },
					'text': { 'font-size': 14, text: '', 'ref-x': .5, 'ref-y': .5, ref: 'rect', 'y-alignment': 'middle', 'x-alignment': 'middle', fill: 'black' },
					'image': { 'ref-x': 2, 'ref-y': 2, ref: 'rect', width: 50, height: 30 }
				},
				id_prop : id_prop,
				ytid : ytid,
				ytbeginning : ytbeginning,
				ytend : ytend,
				text: text

			}, joint.shapes.basic.Generic.prototype.defaults)
		});
		
		{% load staticfiles %}
		var el = new joint.shapes.basic.youtubeVideo({
			position: { x: 0, y: 0 },
			size: { width: 200, height: 100 },
			attrs: { 
				text: { text: wraptext },
				image: { 'xlink:href': "{% static 'gdpcore/yticon.png' %}" }
			}
		});
		graph.addCell(el);		

		el.attr('./display', 'none');	
		graph.addCell(el);	
		
		return el;
	
	}
	
	//Ajouter un syllogisme
	function addSyllogism(id_prop) {
		joint.shapes.basic.syllogism = joint.shapes.basic.Generic.extend({

			markup: '<g class="rotatable">'
						+'<g class="scalable">'
							+'<rect/>'
						+'</g>'
						+'<text/>'
					+'</g>',

			defaults: joint.util.deepSupplement({

				type: 'basic.syllogism',
				size: { width: 30, height: 30 },
				attrs: {
					'rect': { fill: '#EEEEEE', stroke: 1, width: 30, height: 30 },
					'text': { 'font-size': 14, text: '&', 'ref-x': .5, 'ref-y': .5, ref: 'rect', 'y-alignment': 'middle', 'x-alignment': 'middle', fill: 'black' }					
				},
				id_prop : id_prop,
				text: '&'

			}, joint.shapes.basic.Generic.prototype.defaults)
		});	
		var el = new joint.shapes.basic.syllogism();
		el.attr('./display', 'none');
		graph.addCell(el);
		
		syls.push(el);
		
		return el
	};
	
	//Creation d'un lien (avec bonne visibilité)
	function addLink(id_link, id_left_prop, id_right_prop, type_id, autorname){
	
		updateCorrespondances();

		logic =  '<div>'+graph.getCell(propIdCorrespondance[id_left_prop]).get('text')+'</div>'
				+'<div>'+typesData[type_id]['logic']+'</div>'
				+'<div>'+graph.getCell(propIdCorrespondance[id_right_prop]).get('text')+'</div>'			
		
/*		joint.shapes.improvedLink = joint.dia.Link.extend({
			labelMarkup: '<g class="label"><rect /><text /></g>'
		});
		
		var impLi = new joint.shapes.improvedLink({
			source: { id: propIdCorrespondance[id_left_prop] },
			target: { id: propIdCorrespondance[id_right_prop] },
			attrs: {},
			id_link: id_link,
			type_id : type_id,
			link_autorname: autorname,
			logic: logic,
			labels : [
			{ position: 0.5, attrs: { text: { text: 'impli', 'font-size': 12 } } }
			]
		});
		graph.addCell(impLi) ; */
		
		var li = new joint.dia.Link({
			source: { id: propIdCorrespondance[id_left_prop] },
			target: { id: propIdCorrespondance[id_right_prop] },
			attrs: {},
			id_link: id_link,
			type_id : type_id,
			link_autorname: autorname,
			logic: logic,
			labels : [
			{ position: 0.5, attrs: { text: { text: typesData[type_id]['type']+' ('+autorname+')', 'font-size': 12 } } }
			]
		});

		li.attr({
			'.connection': typesData[type_id]['connection'],
			'.marker-source': typesData[type_id]['source'],
			'.marker-target': typesData[type_id]['target']
		});	

		li.attr('./display', 'none');
		
		graph.addCell(li) ;
		linkVisu(li);		
		
		console.log('link added to graph - id_link: '+id_link+' id: '+li.id)
		
		if (typesData[type_id]['type'] != 'syllogisme') {
			addCircToLink(li);
		}
		
		return li	
	}
	
	//Pour ajouter un rond à un lien  (pour pouvoir pointer dessus)
	function addCircToLink(link){	
		source_position = link.getSourceElement().get('position');
		target_position = link.getTargetElement().get('position');
		var middle_position = {};
		middle_position['x'] = (source_position['x']+target_position['x'])/2+80;
		middle_position['y'] = (source_position['y']+target_position['y'])/2+30;
					
		var el = new joint.shapes.fsa.State({
				position: { x: middle_position['x'], y: middle_position['y'] },
				size: { width: 40, height: 40 },
				attrs: {
					text : { text: '', fill: '', 'font-weight': 'normal' },
					'circle': {
						fill: '',
						stroke: '#000000',
						'stroke-width': 0.1
					}
				},
				link_id: link.get('id_link')			
			});	
		el.attr('./display', link.attr('./display'));							
		graph.addCell(el);	
		el.toBack();		
		circles.push(el);
		return el
	};
		
	//Creation d'une implication (avec bonne visibilité)
	function addImp(id_imp, id_imp_link, id_imp_prop, autorname ) {
		var lo = new joint.dia.Link({
			source: { id: circleIdCorrespondance[id_imp_link] },
			target: { id: propIdCorrespondance[id_imp_prop] },
			attrs: {},
			id_implication: id_imp,
			labels : [
			{ position: 0.5, attrs: { text: { text: 'Implication ('+autorname+')', 'font-size': 12 } } }
			]
		});
		
		lo.attr({
			'.connection': typesData[1]['connection'],
			'.marker-source': typesData[1]['source'],
			'.marker-target': typesData[1]['target']
		});					
		lo.attr('./display', 'none');
		graph.addCell(lo) ;
		linkVisu(lo);
		
		console.log('imp added to graph - id_imp: '+id_imp+' id: '+lo.id);
		
		return lo
	}
	
	//MAJ des correspondances
	function updateCorrespondances(){
		
		all_elems = graph.getElements();
		propIdCorrespondance = {};
		circleIdCorrespondance = {};
		all_elems.forEach(function(entry) {
			propIdCorrespondance[entry.get('id_prop')] = entry.id;
			circleIdCorrespondance[entry.get('link_id')] = entry.id;
		});
		
		all_links = graph.getLinks();
		linkIdCorrespondance = {};
		all_links.forEach(function(entry) {
			linkIdCorrespondance[entry.get('id_link')] = entry.id;
		});	

	}
	
	//MAJ de la visibilité d'un lien et du cercle
	function linkVisu(link) {
			if( graph.getCell(link.get('source')['id']).attr('./display') == '' 
			  && graph.getCell(link.get('target')['id']).attr('./display') == '' ) {
					link.attr('./display', '');					
			} else {
					link.attr('./display', 'none');
			}
			
		updateCorrespondances()		
		
		if (circ = graph.getCell( circleIdCorrespondance[link.get('id_link')] )) {
			circ.attr('./display', link.attr('./display'));	
		}
		
	
	}

	//MAJ des visiiblités des liens entourant une cell
	function aroundCellVisu(cell) {
	
		links = graph.getConnectedLinks(cell);	
		links.forEach(function(li) {
			linkVisu(li);
		});
	};
	
	//MAJ de con_display
	function updateConDisplay(cell) {
		$("#cons_display").html('');
		updateCorrespondances();
		
		links = graph.getConnectedLinks(cell, {inbound: true});
		links.forEach(function(entry){
			voisin = entry.getSourceElement();
					
			if (entry.attr('./display') == 'none') {		
				$("#cons_display").append(
					"<div class='con'> "
						+"<span id='"+voisin.get('id_prop')+"' class='glyphicon glyphicon-plus-sign' aria-hidden='true'></span> "
						+typesData[entry.get('type_id')]['inverse']+' '
						+voisin.get('text')
					+'</div>');				
			};
		});

		links = graph.getConnectedLinks(cell, {outbound: true});
		links.forEach(function(entry){
			voisin = entry.getTargetElement();

			
			if (entry.attr('./display') == 'none') {		
				$("#cons_display").append(
					"<div class='con'> "
						+"<span id='"+voisin.get('id_prop')+"' class='glyphicon glyphicon-plus-sign' aria-hidden='true'></span> "
						+typesData[entry.get('type_id')]['type']+' '
						+voisin.get('text')+' ('+entry.get('link_autorname')+')'
					+'</div>');				
			};		
			
			
		});
	};

	//Ajouter des props depuis un Json envoyé par le serveur
	function fromJsonAddProp( entry ) {
		if (entry['model']=='gdpcore.proposition'){	
			if (entry['fields']['nature'] == 'Diagnostic') {
				elem = addProp(
							entry['pk'], 
							entry['fields']['text'], 
							authorList[entry['fields']['autor']]
						);
				
			} else if (entry['fields']['nature'] == 'YT'){				
				elem = addYoutube(
							entry['pk'],
							entry['fields']['text'],
							entry['fields']['ytid'],
							entry['fields']['ytbeginning'],
							entry['fields']['ytend']
						
						);
						
			} else if (entry['fields']['nature'] == 'SY'){				
				elem = addSyllogism(
							entry['pk']
						);						
						
			} else {		
				elem = '';
			}
			return elem;	
		} else {
			return null
		}
	
	};

	//Ajouter des links depuis un Jsons envoyé par le serveur
	function fromJsonAddLink( entry ) {
		if (entry['model']=='gdpcore.link'){				
			li = addLink(
					entry['pk'], 
					entry['fields']['left_prop'], 
					entry['fields']['right_prop'], 
					entry['fields']['type'], 
					authorList[entry['fields']['autor']]
					);	
			return li
		} else {
			return null;
		}
	};
		
	//Firstload : main
	function firstLoad() {
	
		$("#actionProp").hide();
		$("#actionLink").hide();
	
		//Chargement des props (toutes invisibles)
		{% for prop in props%}
		
			{% if prop.nature == 'Diagnostic' %}
				addProp(
					{{prop.id}},
					'{{prop.text|escapejs}}',
					'{{prop.autor.username|escapejs}}'
				);
			{% endif %}
				
			{% if prop.nature == 'YT' %}
				addYoutube(
					{{prop.id}},
					'{{prop.text|escapejs}}',
					'{{prop.ytid}}',
					'{{prop.videoBeginning}}',
					'{{prop.videoEnd}}'
				);
			{% endif %}	

			{% if prop.nature == 'SY' %}
				addSyllogism(
					{{prop.id}}
				);
			{% endif %}					
		{% endfor %}

		updateCorrespondances()

		//Chargement des attributs
		{% for key, value in attributes.items %}
			
			cell = graph.getCell(propIdCorrespondance[{{key}}]);
			cell.translate({{value.x}},{{value.y}});
			cell.attr('./display', '');
			
			
		{% endfor %}

		//Chargement des liens classiques
		{% for link in links%}

			li = addLink(
				{{link.id}}, 
				{{link.left_prop.id}}, 
				{{link.right_prop.id}}, 
				{{link.type}}, 
				'{{link.autor.username|escapejs}}' 
				);
			
			
		{% endfor %}

		updateCorrespondances()

		//Chargement des implications
		{% for implication in implications%}
			imp = addImp(
				'imp{{implication.id}}',
				{{implication.link.id}},
				{{implication.proposition.id}},
				'{{implication.autor.username|escapejs}}'
				);
		{% endfor %}
			
		updateCorrespondances();
		};
		
	firstLoad();
		
// FIN DE l'INITILISATION //

//Events
	//Extension du graph:
	$( "body" ).on("click", ".glyphicon-plus-sign", function(event) {
		id_prop = event.target.id;					
		updateCorrespondances();
		
		//D'abord, on fait apparaitre la prop et son entourage
		clicked_cell = graph.getCell(propIdCorrespondance[id_prop]);
		selected_cell = graph.getCell(selectedElement);
		
		clicked_cell.position( selected_cell.position()['x'], selected_cell.position()['y'] + 200  );
		clicked_cell.attr('./display', '');
		aroundCellVisu(clicked_cell);
		
		//ON MAJ con_display
		updateConDisplay(graph.getCell(selectedElement));
		
		// On va télécharger tous les props, liens et implications 	
		$.ajax({
			url: '/gdpcore/ajax_propenvir/'+id_prop,
			dataType: "html",
			success: function (data) {	
				
				//Créer le catalogue d'auteurs
				JSON.parse(data).forEach(function(entry) {
					if (entry['model']=='auth.user'){
						authorList[entry['pk']] = entry['fields']['username'];
					}
				});				
				
				// Créer toutes les nouvelles props (invisibles)
				JSON.parse(data).forEach(function(entry) {
					if (!(entry['pk'] in propIdCorrespondance)) {
						fromJsonAddProp(entry);
					}
				});	
				
				updateCorrespondances()	
				
				//  Créer tous les nouveux liens (visibilité conditionnelle)
				JSON.parse(data).forEach(function(entry) {
					if (!(entry['pk'] in linkIdCorrespondance)){
						fromJsonAddLink(entry);
					}		
				});
			}
		});	
	});
		
	//Masquer une proposition	
	$( "body" ).on("click", "#remove_prop", function(event) {		

		cell_tbr = graph.getCell(selectedElement);
		cell_tbr.attr('./display', 'none');
						
		aroundCellVisu(cell_tbr);
		
		$("#cons_display").html('');
	});		
	
	//Quicksave	
	$( "body" ).on("click", "#quickSave", function(event) {		

		console.log('quickSave');
		$.ajax( {
			type: "POST",
			url: '/gdpcore/ajax_quicksave/',
			data: { 			
					'graphstring': JSON.stringify(graph),
					'id_graph' : {{graph.id}},				
					'x': originX,
					'y': originY
			},
			beforeSend: function() {
				// setting a timeout
				$('#savedMessage').text('Demande envoyée');
				$('#savedMessage').css('color', 'orange');
				$('#savedMessage').show(0)
			},
			success: function( data ) {		
				console.log('success quicksave');
				$('#savedMessage').text('Sauvegarde effectuée');
				$('#savedMessage').css('color', 'green');
				$('#savedMessage').show(0).delay(3000).hide(0);
				
			}	
		});
		
	});		
	
	// Quand on touche au graph
	paper.on('cell:pointerdown', function(cellView,evt, x, y) { 

		function highlighter(el){
			if (selectedElement != '') {
				selected = graph.getCell(selectedElement);
				selected.attr('rect/stroke', 'black');
				selected.attr('rect/stroke-width', 0);
				selected.attr('circle/stroke', 'black');
				selected.attr('circle/stroke-width', 0);							
				selected.resize(200,100);	
				var wraptext = joint.util.breakText(selected.get('text'), {
					width: 145,
					height: 90,
					attrs: {		
						'text-anchor': 'middle'		
					}
				});					
				selected.attr('.word1/text', wraptext);
				selected.attr('.word2/transform', 'translate(165,82)');							
			}
							
			el.attr('circle/stroke',colors['HL']);
			el.attr('circle/stroke-width', 4);
			el.attr('rect/stroke',colors['HL']);
			el.attr('rect/stroke-width', 4);
						
			if (fulltext = el.get('text') ){
				heightPrediction = fulltext.length*1.1;
			} else {
				heightPrediction = 0;
			}
			if (heightPrediction < 100) {
					heightPrediction = 100
				}
			
			var wraptext = joint.util.breakText(fulltext, {
				width: 145,
				height: heightPrediction,
				attrs: {		
					'text-anchor': 'middle'		
				}
			});	
			
			el.resize(200, heightPrediction);		
			deltaHeight = heightPrediction-20;			
			el.attr('.word1/text', wraptext);	
			el.attr('.word2/transform', 'translate(165,'+deltaHeight+')');
			
			
		};
	
		$("#actionProp").hide();
		$("#actionLink").hide();
		$("#ytplayer").hide();
		player.stopVideo();
		playerPrev.stopVideo();
		answer_playerPrev.stopVideo();
		
		//Test de la nature de cell:
		//Si c'est un lien
		if (cellView.model instanceof joint.dia.Link) {
			
			console.log(cellView.getBBox().center());
			
			$("#actionLink").show();			
			elem = graph.getCell(circleIdCorrespondance[cellView.model.get('id_link')]);
//			$("#logic").html(cellView.model.get('logic'));
		
		//Si c'est un circle		
		} else if (cellView.model instanceof joint.shapes.fsa.State){
			
			$("#actionLink").show();			
			elem = graph.getCell(cellView.model.id);
			link = graph.getCell(linkIdCorrespondance[elem.get('link_id')])
//			$("#logic").html(link.get('logic'));
		//Si c'est une vidéo youtube				
		} else if (cellView.model.get('type') == 'basic.youtubeVideo') {
		
			$("#actionProp").show();
			elem = graph.getCell(cellView.model.id);
//			$("#logic").html('Intitulé : '+elem.get('text'));
						
			$("#ytplayer").show();	
			
			player.loadVideoById({
				'videoId': elem.get('ytid'),
				'startSeconds': elem.get('ytbeginning'),
				'endSeconds': elem.get('ytend'),
				'suggestedQuality': 'large'
			}); 		
		//Si c'est une prop
		} else if (cellView.model.get('type') == 'basic.twoTextRect') {
				
			$("#actionProp").show();
			$("#actionLink").hide();
			
			elem = graph.getCell(cellView.model.id);
//			$("#logic").html('Intitulé : '+elem.get('text'));	
		} else if (cellView.model.get('type') == 'basic.syllogism') {
			
			elem = graph.getCell(cellView.model.id);
		}
		
		updateCorrespondances();
		highlighter(elem);
		updateConDisplay(elem);
		selectedElement = elem.id
			
	});
	
	//Quand on bouge des propositions : Calcul des positions des cercles
	graph.on('change', function(cell) { 
	
		updateCorrespondances();
		//Calcul des positions des cercles
		$.each( circles, function( index, value ){
			
			if (value.attr('./display') == ''){
			
				cell = graph.getCell(linkIdCorrespondance[value.get('link_id')]);				
								
/*				var srcId = cell.get('source').id || cell.previous('source').id;
				var trgId = cell.get('target').id || cell.previous('target').id

				var srcCenter = graph.getCell(srcId).getBBox().center();
				var trgCenter = graph.getCell(trgId).getBBox().center();
				var midPoint = g.line(srcCenter, trgCenter).midpoint();		 
				value.position( midPoint['x'] - 20, midPoint['y'] - 20 );

*/	
	
				var linkView = paper.findViewByModel(cell);
				var connectionEl = linkView.$('.connection')[0];
				var connectionLength = connectionEl.getTotalLength();

				var position = connectionEl.getPointAtLength(connectionLength/2);
				

				value.position( position['x'] - 20, position['y'] - 20 );

			}
		});
		
		$.each( syls, function( index, value ){
			
			if (value.attr('./display') == ''){
				
				neighbors = graph.getNeighbors(value);
				var sumX = 0;
				var sumY = 0;
				
				var i = 0;
				var len = neighbors.length;

				for (; i < len; i++) { 
				
					sumX = sumX + neighbors[i].get('position')['x'];
					sumY = sumY + neighbors[i].get('position')['y'];
				}
				
				value.position(sumX/len + 85, sumY/len + 45);				
			}
		});		
		
		
	})
    	
//Events liés aux modaux//


// Modal save graph
	$( "body" ).on("click", "#save_graph", function(event) {		
	
		title = $('#graph_title').val();

		$.ajax({
			url: '/gdpcore/save_graph/',
			type: 'POST',
			data: JSON.stringify({graph ,'title': title, 'origin': {'x': originX, 'y': originY} }),
			processData: false,
			contentType: 'application/json',
			success: function (data) {					
				console.log('sauvegarde effectuée')	;
				$('#modalSave').modal('hide')
			},
			failure: function(data) { 
				 console.log('dadada');
			}
		});

	});
// Modal ajouter réponse + lien:
$(function(){	

/*	$("#modalAnswer").draggable({
		handle: ".modal-header"
	});*/
	
	//Mettre le bon titre + init
	$('#modalAnswer').on('show.bs.modal', function (event) {
		$('#myTabs a:first').tab('show');
		var modal = $(this);
		modal.find('#ini_prop_answer').text(
			graph.getCell(selectedElement).get('text')
		);
		
	});
	
	// Mettre la bonne logique
	$( ".newprop" ).change(function() {
		$( "#answerLogic" ).html( 
					"<div>"+$( "#ini_prop_answer" ).html()+"</div><div>"
					+typesData[$('input[name=optionsRadios]:checked').val()]['logic']+"</div><div>	"
					+$( "#newprop" ).val()+"</div>" 
		);
	});	
	
	// Recherche propositions similaires
	$("#recherche_but").click(function() {

		$.ajax( {
			type: "POST",
			url: '/gdpcore/getSimil/',
			data: { 
					text: $("#newprop").val(),
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
			success: function( data ) {		
				
				$("#existingPropsAnswer_modalAnswer").html('');
				
				data['hits']['hits'].forEach(function(entry) {

					$("#existingPropsAnswer_modalAnswer").append(
					
						'<div class="radio"><label>'
							+'<input type="radio" name="optionsExisting" value="'+entry['_id']+'">'
								+entry['_source']['text']+' '
								+entry['_score']					
						+'</label"></div>'
						
					);	
				});
				
				if (data['hits']['total'] == 0 ) {				
					$("#existingPropsAnswer_modalAnswer").append('Pas de résultat');
				}
			}
		});		
	
	
	
	});	
	
	//Si tout est bon, on lance la demande, et on modifie le graph avec la réponse
	$("#submit_answer").click(function() {		
		$.ajax( {
			type: "POST",
			url: '/gdpcore/ajax_newanswer/',
			data: { 
					nature: 'diagnostic',
					id_prop: graph.getCell(selectedElement).get('id_prop'),
					newprop: $("#newprop").val(),					
					type_id: $('input[name=optionsRadios]:checked').val(),
					csrfmiddlewaretoken: '{{ csrf_token }}'
			},
				
			success: function( data ) {		
				$('#modalAnswer').modal('hide');
				$( "#answerLogic" ).html('');
				$( "#newprop" ).val('');
				

				//Créer le catalogue d'auteurs
				JSON.parse(data).forEach(function(entry) {
					if (entry['model']=='auth.user'){
						authorList[entry['pk']] = entry['fields']['username'];
					}
				});				
				
				//Props
				JSON.parse(data).forEach(function(entry) {
					elem = fromJsonAddProp(entry);					
					if (elem) {
						elem.attr('./display', '');					
						elem.position(
							graph.getCell(selectedElement).position()['x'],
							graph.getCell(selectedElement).position()['y'] + 100
						);
					}										
				});			
				
				updateCorrespondances()				
				//Links
				JSON.parse(data).forEach(function(entry) {
					fromJsonAddLink( entry );					 
				});
			}
		});
	});

	//Visualisation extrait
	$("#answer_youtubePreview").click(function() {
		answer_playerPrev.loadVideoById({
			'videoId': $("#answer_youtubeId").val(),
			'startSeconds': $("#answer_youtubeBegin").val(),
			'endSeconds': $("#answer_youtubeEnd").val(),
			'suggestedQuality': 'large'
		});
	});
	
	//Si tout est bon, on lance la demande, et on modifie le graph avec la réponse
	$("#answer_youtubeSubmit").click(function() {
		$.ajax({
			type: "POST",
			url: '/gdpcore/ajax_newanswer/',
			data: { 
					nature: 'youtube',
					id_prop: graph.getCell(selectedElement).get('id_prop'),
					youtubeTitle: $("#answer_youtubeTitle").val(),
					youtubeId: $("#answer_youtubeId").val(),
					youtubeBegin: $("#answer_youtubeBegin").val(),
					youtubeEnd: $("#answer_youtubeEnd").val(),
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
			success: function( data ) {	
				$('#modalAnswer').modal('hide');
				answer_playerPrev.stopVideo();				
				updateCorrespondances()				
				JSON.parse(data).forEach(function(entry) {

					el = fromJsonAddProp(entry)
					el.attr('./display', '');
					el.position(-originX,-originY);			
					updateCorrespondances()
													 
				});
				JSON.parse(data).forEach(function(entry) {

					fromJsonAddLink(entry);
													 
				});				
				
				
			}
		});
	});	
	
	
	
});
// Modal forum:
$(function(){
	//Mettre le bon titre + loader les comments
	$('#modalForum').on('show.bs.modal', function (event) {
		var modal = $(this);
		modal.find('.modal-title').text(
					graph.getCell(selectedElement).get('text')
				);
		$('#modalForumContent').html('')
		
		$.ajax({
		  url: '/gdpcore/ajax_getcomments/'+graph.getCell(selectedElement).get('id_prop'),
		  dataType: 'json',
		  success: function( data ) {
					
					JSON.parse(data).forEach(function(entry) {
						$('#modalForumContent').append('<li>'
							+entry['fields']['autor']
							+' : '
							+entry['fields']['text']
							+'</li>')
					});
				},
		  
		});
	});

	//Si user veut envoyer un nouveau message
	$("#comment_submit").click(function() {
		
		$.ajax( {
			type: "POST",
			url: '/gdpcore/ajax_newcomment/',
			data: { 
					id_prop: graph.getCell(selectedElement).get('id_prop'),
					comment_text: $("#comment_text").val()
				},
			success: function( data ) {
				$("#comment_text").val('')

				JSON.parse(data).forEach(function(entry) {
						$('#modalForumContent').append('<li>'
							+entry['fields']['autor']
							+' : '
							+entry['fields']['text']
							+'</li>')					
				});						
			}
		});			
	});
});
// Modal edition:
$(function(){
	//Mettre le bon texte..
	$('#modalEdit').on('show.bs.modal', function (event) {
	  var modal = $(this);
	  modal.find('#edit_prop').val(
					graph.getCell(selectedElement).get('text')
				);
	});
	
	// Recherche propositions similaires
	$("#edit_recherche_but").click(function() {
		
	  $('#new_window_parameter_1').val($( "#edit_prop" ).val());
	  $('#invisible_form').submit();
	});	

	//Si tout est bon, on lance la demande, et on modifie le graph avec la réponse
	$("#submit_edition").click(function() {
	

		$.ajax({
			type: "POST",
			url: '/gdpcore/ajax_editprop/',
			data: { 
					id_prop: graph.getCell(selectedElement).get('id_prop'),
					edit_prop: $("#edit_prop").val()	
				},
			success: function( data ) {	
				$('#modalEdit').modal('hide');

				
				updateCorrespondances()				
				JSON.parse(data).forEach(function(entry) {
					if (entry['model']=='gdpcore.proposition'){						
						edit_cell = graph.getCell(propIdCorrespondance[entry['pk']]);
										
						var wraptext = joint.util.breakText(entry['fields']['text'], {
							width: 145,
							height: 90,
							attrs: {		
								'text-anchor': 'middle'		
							}
						});	
						
						edit_cell.attr('.word1/text', wraptext);
					}
					
					updateCorrespondances()
										
					if (entry['model']=='gdpcore.link'){
					
/*						link = graph.getCell(linkIdCorrespondance[entry['pk']]);
						link.label(0, { 
										attrs: { 
											position: 0.2, 
											attrs: { 
												text: { 
													text: 'lala', 
													'font-size': 12 
												} 
											} 
										} 
									  } 
								);
*/						
						
					}			 
				}) 
			}
		});
	});		
});
// Modal newprop
$(function(){
	// Recherche propositions similaires
	$("#newprop_recherche_but").click(function() {
		
	  $('#new_window_parameter_1').val($( "#propnew" ).val());
	  $('#invisible_form').submit();
	});	
	
	//Si tout est bon, on lance la demande, et on modifie le graph avec la réponse
	$("#submit_newprop").click(function() {
		$.ajax({
			type: "POST",
			url: '/gdpcore/ajax_newprop/',
			data: { 
					nature: 'diagnostic',
					newprop: $("#propnew").val(),
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
			success: function( data ) {	
				$('#modalNewprop').modal('hide');
			//	console.log(data);
			
				$("#propnew").val('');
				
				updateCorrespondances()				
				JSON.parse(data).forEach(function(entry) {
					if (entry['model']=='gdpcore.proposition'){	
	
						el = addProp(
							entry['pk'], 
							entry['fields']['text'], 
							authorList[entry['fields']['autor']]
							);
						el.attr('./display', '');
						el.position(-originX,-originY);
					}				
					updateCorrespondances()
													 
				}) 
			}
		});
	});

	//Preview Youtube
	$("#youtubePreview").click(function() {
			playerPrev.loadVideoById({
				'videoId': $("#youtubeId").val(),
				'startSeconds': $("#youtubeBegin").val(),
				'endSeconds': $("#youtubeEnd").val(),
				'suggestedQuality': 'large'
			});
	});
	
	//Si tout est bon, on lance la demande, et on modifie le graph avec la réponse
	$("#youtubeSubmit").click(function() {
		$.ajax({
			type: "POST",
			url: '/gdpcore/ajax_newprop/',
			data: { 
					nature: 'youtube',
					youtubeTitle: $("#youtubeTitle").val(),
					youtubeId: $("#youtubeId").val(),
					youtubeBegin: $("#youtubeBegin").val(),
					youtubeEnd: $("#youtubeEnd").val(),
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
			success: function( data ) {	
				$('#modalNewprop').modal('hide');
//				playerPrev.stopVideo();				
				updateCorrespondances()				
				JSON.parse(data).forEach(function(entry) {
					el = fromJsonAddProp(entry)
					el.attr('./display', '');
					el.position(-originX,-originY);	
					updateCorrespondances()
													 
				}) 
			}
		});
	});	
	
});
//Modal connectprop
$(function(){
	//Mettre le bon titre
	$('#modalConnect').on('show.bs.modal', function (event) {
		var modal = $(this);
		modal.find('#ini_prop_connect').text(
					graph.getCell(selectedElement).get('text')
				);
				
				
		$('#listprops').html('');	
		allCells = graph.getCells();
		allCells.forEach(function(entry) {	
			if (
				entry.attr("./display") == ''
				&& entry.id != selectedElement 
				&& entry.get('text')
				){
				$('#listprops').append('<option value='+entry.get('id_prop')+'>'+entry.get('text')+'</option>');
			}
		});
				
	});
	
	// Mettre la bonne logique
	$( ".newprop" ).change(function() {

		$( "#connectLogic" ).html( 
					"<div>"+$( "#ini_prop_connect" ).html()+"</div>"
					+"<div>"+typesData[$('input[name=connectOptions]:checked').val()]['logic']+"</div>"
					+"<div>"+$( "#listprops option:Selected" ).text()+"</div>" 
							);
	});	
	
	//Si tout est bon, on lance la demande, et on modifie le graph avec la réponse
	$("#submit_connect").click(function() {
			
		$.ajax( {
			type: "POST",
			url: '/gdpcore/ajax_connect/',
			data: { 
					left_prop: graph.getCell(selectedElement).get('id_prop'),
					right_prop: $("#listprops").val(),					
					type_id: $('input[name=connectOptions]:checked').val(),
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
			success: function( data ) {		
				$('#modalConnect').modal('hide')
				
				JSON.parse(data).forEach(function(entry) {
					if (entry['model']=='gdpcore.proposition'){
					
					}
		
					updateCorrespondances()
										
					if (entry['model']=='gdpcore.link'){
					
						li = addLink(
								entry['pk'], 
								entry['fields']['left_prop'], 
								entry['fields']['right_prop'], 
								entry['fields']['type'], 
								authorList[entry['fields']['autor']]
								);			
					}			 
				});
			}
		});
	});
});	
//Modal attack link
$(function(){
	//Mettre la bonne logique
	$('#modalLinkAttack').on('show.bs.modal', function (event) {
		var modal = $(this);
		
		updateCorrespondances;
		modal.find('#attackLogic').html ( 
			graph.getCell ( 
				linkIdCorrespondance [ 
					graph.getCell(selectedElement).get('link_id')
				]
			)
			.get('logic') 
		);							
	});
	
	//Si tout est bon, on lance la demande, et on modifie le graph avec la réponse
	$("#submitAttack").click(function() {
	
		$.ajax( {
			type: "POST",
			url: '/gdpcore/ajax_linkattack/',
			data: { 
					id_link: graph.getCell(selectedElement).get('link_id'),
					linkImplication: $("#linkImplication").val(),					
					linkAttack: $("#linkAttack").val()
				},
			success: function( data ) {		
				$('#modalLinkAttack').modal('hide')
				
				JSON.parse(data).forEach(function(entry) {
					if (entry['model']=='gdpcore.proposition'){
					 
						prop = addProp(
							entry['pk'], 
							entry['fields']['text'], 
							authorList[ entry['fields']['autor'] ]
						);
						prop.attr('./display','');
							
					}	
					updateCorrespondances()
										
					if (entry['model']=='gdpcore.link'){
					
						li = addLink(
								entry['pk'], 
								entry['fields']['left_prop'], 
								entry['fields']['right_prop'], 
								entry['fields']['type'], 
								authorList[entry['fields']['autor']]
								);		
					}			 
				});
			}
		});
	});		
});	
//Modal remove link
$(function(){
	//Mettre la bonne logique
	$('#modalLinkRemove').on('show.bs.modal', function (event) {
		var modal = $(this);
		
		updateCorrespondances;
		modal.find('#removeLogic').html ( 
			graph.getCell ( 
				linkIdCorrespondance [ 
					graph.getCell(selectedElement).get('link_id')
				]
			)
			.get('logic') 
		);							
	});
	
	//Si tout est bon, on lance la demande, et on modifie le graph avec la réponse
	$("#submitRemove").click(function() {
	
		$.ajax( {
			type: "POST",
			url: '/gdpcore/ajax_linkremove/',
			data: { 
					id_link: graph.getCell(selectedElement).get('link_id')
				},
			success: function( data ) {	
					
				cir = graph.getCell(selectedElement);			
				updateCorrespondances();							
				lin = graph.getCell(
					linkIdCorrespondance[
						cir.get('link_id')
					]
				);
				
				lin.remove();
				cir.remove();
				
				selectedElement = '';
				
				var index = circles.indexOf(cir);
				if (index > -1) {
					circles.splice(index, 1);
				}
				
				$('#modalLinkRemove').modal('hide')					
				}
			
		});
	});			
});
//Modal syllogism
$(function(){

	//Mettre les choix
	$('#modalSyllogism').on('show.bs.modal', function (event) {
		var modal = $(this);
		
		$('#majorPremise').html('');
		$('#minorPremise').html('');
		$('#syllogismConclusion').html('');
		
		allCells = graph.getCells();
		allCells.forEach(function(entry) {	
			if (
				entry.attr("./display") == ''
				&& entry.get('text')
				){
				$('#majorPremise').append('<option value='+entry.get('id_prop')+'>'+entry.get('text')+'</option>');
				$('#minorPremise').append('<option value='+entry.get('id_prop')+'>'+entry.get('text')+'</option>');
				$('#syllogismConclusion').append('<option value='+entry.get('id_prop')+'>'+entry.get('text')+'</option>');
			}
		});
				
	});
	
	// Mettre la bonne logique
	$( ".syllogismProps" ).change(function() {

		$( "#syllogismLogic" ).html( 
					"<div>"+$( "#majorPremise option:Selected" ).text()+"</div>"
					+"<div>Or</div>"
					+"<div>"+$( "#minorPremise option:Selected" ).text()+"</div>" 
					+"<div>Donc</div>"
					+"<div>"+$( "#syllogismConclusion option:Selected" ).text()+"</div>"
							);
	});	
	
	//Envoyer la requete
	$("#submitSyllogism").click(function() {
			
		$.ajax( {
			type: "POST",
			url: '/gdpcore/ajax_newsyllogism/',
			data: { 
					majorPremise: $("#majorPremise").val(),
					minorPremise: $("#minorPremise").val(),					
					syllogismConclusion: $("#syllogismConclusion").val(),	
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
			success: function( data ) {		
				$('#modalSyllogism').modal('hide')
				
				JSON.parse(data).forEach(function(entry) {
					if (entry['model']=='gdpcore.proposition'){						
						el = fromJsonAddProp(entry);
						el.attr('./display', '');
					}
		
					updateCorrespondances()
										
					if (entry['model']=='gdpcore.link'){			
						fromJsonAddLink(entry);
					}
				});
			}
		});
	});

});
//Modal summary
$(function(){
	//Mettre les choix
	$('#modalSummary').on('show.bs.modal', function (event) {
		var modal = $(this);
		
		$('#summaryPour').html('');
		$('#summaryContre').html('');
		$('#summaryNeutre').html('');
				
		cell = graph.getCell(selectedElement);
		links = graph.getConnectedLinks(cell, {inbound: true});

		pours = ['donc', 'exemple']
		contres = ['concurrence', 'contre-exemple']
		
		links.forEach(function(entry){
			voisin = entry.getSourceElement();				
			if (entry.attr('./display') == '') {
				if ( ( $.inArray(typesData[entry.get('type_id')]['type'] , pours) > -1) ) {							
					$("#summaryPour").append(
						"<div>"
							+typesData[entry.get('type_id')]['inverse']+' '
							+voisin.get('text')
						+'</div>');	
				} else if ( ( $.inArray(typesData[entry.get('type_id')]['type'] , contres) > -1) ) {				
					$("#summaryContre").append(
						"<div>"
							+typesData[entry.get('type_id')]['inverse']+' '
							+voisin.get('text')
						+'</div>');																	
				} else {			
					$("#summaryNeutre").append(
						"<div>"
							+typesData[entry.get('type_id')]['inverse']+' '
							+voisin.get('text')
						+'</div>');																
				}
			};
		});

		links = graph.getConnectedLinks(cell, {outbound: true});
		links.forEach(function(entry){
			voisin = entry.getTargetElement();
			if (entry.attr('./display') == '') {	
				if ( ( $.inArray(typesData[entry.get('type_id')]['type'] , pours) > -1) ) {							
					$("#summaryPour").append(
						"<div>"
							+typesData[entry.get('type_id')]['type']+' '
							+voisin.get('text')
						+'</div>');	
				} else if ( ( $.inArray(typesData[entry.get('type_id')]['type'] , contres) > -1) ) {				
					$("#summaryContre").append(
						"<div>"
							+typesData[entry.get('type_id')]['type']+' '
							+voisin.get('text')
						+'</div>');																	
				} else {			
					$("#summaryNeutre").append(
						"<div>"
							+typesData[entry.get('type_id')]['type']+' '
							+voisin.get('text')
						+'</div>');																
				}	
			};
		});
	});
		
});
//Modal existingprop
$(function(){

	//Envoyer la requete
	$("#existingSeek").click(function() {
			
		$.ajax( {
			type: "POST",
			url: '/gdpcore/getSimil/',
			data: { 
					text: $("#existingInput").val(),
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
			success: function( data ) {		
				
				$("#existingPropsAnswer").html('');
				
				data['hits']['hits'].forEach(function(entry) {

					$("#existingPropsAnswer").append(
					
						'<div class="radio"><label>'
							+'<input type="radio" name="optionsExisting" value="'+entry['_id']+'">'
								+entry['_source']['text']+' '
								+entry['_score']					
						+'</label"></div>'
						
					);	

				});
				
				if (data['hits']['total'] == 0 ) {				
					$("#existingPropsAnswer").append('Pas de résultat');
				}
			}
		});
	});
	
	$("#existingSubmit").click(function() {
			
			
			
		id_prop = $('input[name=optionsExisting]:checked').val();	
			
		$.ajax({
			url: '/gdpcore/ajax_propenvir/'+id_prop,
			dataType: "html",
			success: function (data) {	
			
				console.log(data);
				
				$('#modalExistingprop').modal('hide')	
				//Créer le catalogue d'auteurs
				JSON.parse(data).forEach(function(entry) {
					if (entry['model']=='auth.user'){
						authorList[entry['pk']] = entry['fields']['username'];
					}
				});				
				
				// Créer toutes les nouvelles props (invisibles)
				JSON.parse(data).forEach(function(entry) {
					if (!(entry['pk'] in propIdCorrespondance)) {
						fromJsonAddProp(entry);
					}
				});
				
				updateCorrespondances()	
				graph.getCell(propIdCorrespondance[id_prop]).attr('./display', '');
										
				//  Créer tous les nouveux liens (visibilité conditionnelle)
				JSON.parse(data).forEach(function(entry) {
					if (!(entry['pk'] in linkIdCorrespondance)){
						fromJsonAddLink(entry);
					}		
				});
			}
		});	
	});	
	
});


	
//NAV PAPER	
	//Initial Parameters
	var gridsize = 1;
	var currentScale = 1;

	//Get the div that will hold the graph
	var targetElement= $('#myholder')[0];

	//Bonus function use (see below) - create dotted grid
//	setGrid(paper, gridsize*15, '#808080');

	//Setup  svgpan and zoom, with handlers that set the grid sizing on zoom and pan
	//Handlers not needed if you don't want the dotted grid
	panAndZoom = svgPanZoom(targetElement.childNodes[0], 
	{
		viewportSelector: targetElement.childNodes[0].childNodes[0],
		fit: false,
		zoomScaleSensitivity: 0.4,
		panEnabled: false,
		onZoom: function(scale){
			currentScale = scale;
//			setGrid(paper, gridsize*15*currentScale, '#808080');
		},
		beforePan: function(oldpan, newpan){
//			setGrid(paper, gridsize*15*currentScale, '#808080', newpan);
		}
	});

	//Enable pan when a blank area is click (held) on
	paper.on('blank:pointerdown', function (evt, x, y) {
		panAndZoom.enablePan();
		//console.log(x + ' ' + y);
	});

	//Disable pan when the mouse button is released
	paper.on('cell:pointerup blank:pointerup', function(cellView, event) {
	  panAndZoom.disablePan();
	});


	//BONUS function - will add a css background of a dotted grid that will scale reasonably
	//well with zooming and panning.
	function setGrid(paper, size, color, offset) {
		// Set grid size on the JointJS paper object (joint.dia.Paper instance)
		paper.options.gridsize = gridsize;
		// Draw a grid into the HTML 5 canvas and convert it to a data URI image
		var canvas = $('<canvas/>', { width: size, height: size });
		canvas[0].width = size;
		canvas[0].height = size;
		var context = canvas[0].getContext('2d');
		context.beginPath();
		context.rect(1, 1, 1, 1);
		context.fillStyle = color || '#AAAAAA';
		context.fill();
		// Finally, set the grid background image of the paper container element.
		var gridBackgroundImage = canvas[0].toDataURL('image/png');
		$(paper.el.childNodes[0]).css('background-image', 'url("' + gridBackgroundImage + '")');
		if(typeof(offset) != 'undefined'){  
			$(paper.el.childNodes[0]).css('background-position', offset.x + 'px ' + offset.y + 'px');
		}
	}
		
	

	$( "body" ).on("click", "#adminBut", function(event) {		
	
		console.log(JSON.stringify(graph.getCells()));
		
	});
	
	$( "body" ).on("click", "#commentGraphSubmit", function(event) {		
	
		$.ajax( {
			type: "POST",
			url: '/gdpcore/ajax_addcommentgraph/',
			data: { 
					text: $("#commentGraphInput").val(),
					graph_id: {{graph.pk}},
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
			success: function( data ) {		
				
				console.log(data);
				$("#commentsGraph").append(
					"<div>"
						+authorList[ JSON.parse(data)[0]['fields']['author'] ] +' '+JSON.parse(data)[0]['fields']['text']
					+'</div>'
				);	
				
				
			}
		});
		
	});	
	

	
});


	
</script>
	
{% endblock %}